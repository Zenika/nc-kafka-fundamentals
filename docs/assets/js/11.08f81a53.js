(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{366:function(e,a,r){"use strict";r.r(a);var t=r(44),n=Object(t.a)({},(function(){var e=this,a=e.$createElement,r=e._self._c||a;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"lab03-consumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#lab03-consumer"}},[e._v("#")]),e._v(" Lab03 - Consumer")]),e._v(" "),r("h2",{attrs:{id:"rappel"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#rappel"}},[e._v("#")]),e._v(" Rappel")]),e._v(" "),r("p",{staticStyle:{"text-align":"center"}},[r("img",{attrs:{src:"lab03.png",alt:"lab03"}})]),e._v(" "),r("h2",{attrs:{id:"preparer-le-projet"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#preparer-le-projet"}},[e._v("#")]),e._v(" Préparer le projet")]),e._v(" "),r("ul",[r("li",[r("p",[e._v("⚠️ Checkout de la branche "),r("code",[e._v("step03")]),e._v(" ⚠️.")])]),e._v(" "),r("li",[r("p",[e._v("Se placer dans le répertoire "),r("code",[e._v("Lab03-consumer")])])])]),e._v(" "),r("h2",{attrs:{id:"un-peu-de-code"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#un-peu-de-code"}},[e._v("#")]),e._v(" Un peu de code")]),e._v(" "),r("ul",[r("li",[r("p",[e._v("Au sein de ce lab nous utilisons "),r("a",{attrs:{href:"https://spring.io/projects/spring-kafka",target:"_blank",rel:"noopener noreferrer"}},[e._v("spring-kafka"),r("OutboundLink")],1),e._v(" pour dialoguer avec Kafka au\nsein de l'écosystème Spring Boot.")])]),e._v(" "),r("li",[r("p",[e._v("Nous allons découvrir en substance, comment recevoir / consommer un message à l'aide de Spring Kafka. Pour plus de\ndocumentations :\n"),r("a",{attrs:{href:"https://docs.spring.io/spring-kafka/reference/html/#receiving-messages",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.spring.io/spring-kafka/reference/html/#receiving-messages"),r("OutboundLink")],1)])]),e._v(" "),r("li",[r("p",[e._v("En effet pour consommer un message vous disposez de plusieurs façons de faire avec Spring Kafka:")]),e._v(" "),r("ul",[r("li",[e._v("en utilisant\nun "),r("code",[e._v("Consumer")]),e._v(" "),r("a",{attrs:{href:"https://kafka.apache.org/26/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://kafka.apache.org/26/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html"),r("OutboundLink")],1)]),e._v(" "),r("li",[e._v("en utilisant une annotation listener (pour masquer une certaine\ncomplexité) "),r("code",[e._v("KafkaListener")]),e._v(" "),r("a",{attrs:{href:"https://docs.spring.io/spring-kafka/api/org/springframework/kafka/annotation/KafkaListener.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.spring.io/spring-kafka/api/org/springframework/kafka/annotation/KafkaListener.html"),r("OutboundLink")],1)])])])]),e._v(" "),r("h3",{attrs:{id:"utilisation-de-l-api-consumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#utilisation-de-l-api-consumer"}},[e._v("#")]),e._v(" Utilisation de l'API "),r("code",[e._v("Consumer")])]),e._v(" "),r("ul",[r("li",[r("p",[e._v("Explorer le projet Spring Boot "),r("code",[e._v("Lab03-consumer")])]),e._v(" "),r("ul",[r("li",[e._v("La configuration présente dans le fichier "),r("code",[e._v("application.properties")])]),e._v(" "),r("li",[e._v("L'auto-configuration de "),r("code",[e._v("ConsumerFactory<String, String>")])])])]),e._v(" "),r("li",[r("p",[e._v("Compléter la méthode "),r("code",[e._v("KafkaRestConsumer#consume()")])])])]),e._v(" "),r("blockquote",[r("p",[e._v("Indices:")]),e._v(" "),r("ul",[r("li",[r("em",[e._v("create consumer")])]),e._v(" "),r("li",[r("em",[e._v("consumer close")])]),e._v(" "),r("li",[r("em",[e._v("subscribe on topic")])]),e._v(" "),r("li",[r("em",[e._v("poll and for each")])]),e._v(" "),r("li",[r("em",[e._v("send from emitter")])]),e._v(" "),r("li",[r("em",[e._v("close again")])])])]),e._v(" "),r("h3",{attrs:{id:"utilisation-de-l-annotation-kafkalistener"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#utilisation-de-l-annotation-kafkalistener"}},[e._v("#")]),e._v(" Utilisation de l'annotation "),r("code",[e._v("KafkaListener")])]),e._v(" "),r("ul",[r("li",[r("p",[e._v("Annotation "),r("code",[e._v("@KafkaListener")])]),e._v(" "),r("ul",[r("li",[e._v("Le "),r("code",[e._v("@KafkaListener")]),e._v(" est une annotation pour désigner une méthode comme écouteur/consumer.")])])]),e._v(" "),r("li",[r("p",[e._v("Principe de Dead-Letter Topic (DLT)")]),e._v(" "),r("ul",[r("li",[e._v("Vous pouvez configurer un handler (ex : "),r("code",[e._v("SeekToCurrentErrorHandler")]),e._v(") avec un récupérateur d'enregistrements\nlorsque le nombre maximal d'échecs est atteint pour un record")]),e._v(" "),r("li",[e._v("Spring-Kafka fournit également le "),r("code",[e._v("DeadLetterPublishingRecoverer")]),e._v(", qui publie le message d'échec dans un autre\ntopic")]),e._v(" "),r("li",[e._v("cf. "),r("a",{attrs:{href:"./consumer/src/main/java/com/zenika/kafka/consumer/config/KafkaConfigListener.java"}},[e._v("KafkaConfigListener")])])])]),e._v(" "),r("li",[r("p",[e._v("Pour utiliser l'annotation "),r("code",[e._v("@KafkaListener")]),e._v(" et le principe de Dead-Letter Topic, il faut activer le profil\nSpring "),r("code",[e._v("listener")]),e._v(", le listener sur le topic "),r("code",[e._v("vehicle-positions")]),e._v(" va générer une exception sur tous les records ayant un\n"),r("strong",[e._v("offset pair")]),e._v(", pour rediriger ce record sur une DLT "),r("code",[e._v("vehicle-positions.DLT")]),e._v(".")]),e._v(" "),r("ul",[r("li",[e._v("cf. "),r("a",{attrs:{href:"./consumer/src/main/java/com/zenika/kafka/consumer/service/KafkaListenerConsumer.java"}},[e._v("KafkaListenerConsumer")])])])])]),e._v(" "),r("h3",{attrs:{id:"demarrer-votre-application-en-local"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#demarrer-votre-application-en-local"}},[e._v("#")]),e._v(" Démarrer votre application en local")]),e._v(" "),r("ul",[r("li",[r("p",[e._v("Jouer avec le "),r("code",[e._v("wait")]),e._v(", vérifier le lag dans akhq, afficher le topic "),r("code",[e._v("__consumer_offset")])])]),e._v(" "),r("li",[r("p",[e._v("Pour builder et démarrer le conteneur")])])]),e._v(" "),r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[e._v("docker build -t vp-consumer "),r("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v("\ndocker run --name vp-consumer --network"),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tz-kafka-network -d vp-consumer\n")])])]),r("h3",{attrs:{id:"demarrer-votre-application-en-local-2"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#demarrer-votre-application-en-local-2"}},[e._v("#")]),e._v(" Démarrer votre application en local")]),e._v(" "),r("ul",[r("li",[e._v("Il s'agit d'un projet Maven qui dispose d'un wrapper "),r("code",[e._v("mvnw")]),e._v(" et du plugin "),r("code",[e._v("spring-boot-maven-plugin")]),e._v(", vous pouvez\ndémarrer votre application spring en local à l'aide de la commande suivante :")])]),e._v(" "),r("blockquote",[r("p",[e._v("Se placer dans le bon répertoire "),r("code",[e._v("Lab03-consumer")])])]),e._v(" "),r("div",{staticClass:"language-shell extra-class"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[e._v("./mvnw spring-boot:run\n")])])]),r("ul",[r("li",[e._v("Visualiser la consommation des messages sur l'url suivante : "),r("a",{attrs:{href:"http://localhost:8091",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://localhost:8091"),r("OutboundLink")],1)])]),e._v(" "),r("blockquote",[r("ul",[r("li",[e._v("Que voyez-vous sur l'IHM ?")]),e._v(" "),r("li",[e._v("Observez AKHQ "),r("a",{attrs:{href:"http://akhq:8080/ui/server/topic",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://akhq:8080/"),r("OutboundLink")],1),e._v(" ?")]),e._v(" "),r("li",[e._v("Que représente le lag dans AKHQ ?")])])]),e._v(" "),r("p",[r("img",{attrs:{src:"lag.png",alt:"lag.png"}})]),e._v(" "),r("h2",{attrs:{id:"packager-votre-application-avec-docker"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#packager-votre-application-avec-docker"}},[e._v("#")]),e._v(" Packager votre application avec Docker")]),e._v(" "),r("ul",[r("li",[e._v("Pour builder et démarrer le conteneur")])]),e._v(" "),r("blockquote",[r("p",[e._v("Se placer dans le bon répertoire "),r("code",[e._v("Lab03-consumer")])])]),e._v(" "),r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[e._v("docker build -t vp-consumer "),r("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v("\n")])])]),r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[e._v("docker run --name vp-consumer --network"),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tz-kafka-network -p "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("8091")]),e._v(":8091 -d vp-consumer\n")])])]),r("ul",[r("li",[e._v("Pour démarrer votre conteneur avec le profile "),r("code",[e._v("listener")])])]),e._v(" "),r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[e._v("docker run --name vp-consumer --network"),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tz-kafka-network -p "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("8091")]),e._v(":8091 -e "),r("span",{pre:!0,attrs:{class:"token string"}},[e._v('"SPRING_PROFILES_ACTIVE=listener"')]),e._v(" -d vp-consumer\n")])])]),r("blockquote",[r("p",[e._v("Supprimer le conteneur si déjà présent")]),e._v(" "),r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[e._v("docker container stop vp-consumer\ndocker container "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("rm")]),e._v(" vp-consumer\n")])])])]),e._v(" "),r("h2",{attrs:{id:"solution"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#solution"}},[e._v("#")]),e._v(" Solution")]),e._v(" "),r("p",[e._v("Vous vous doutez que pour disposer des solutions de la "),r("code",[e._v("step03")]),e._v(", il vous suffit de️ checkout la branche "),r("code",[e._v("step04")]),e._v(" 😊")])])}),[],!1,null,null,null);a.default=n.exports}}]);